//------------------------------------------------------------------------------
// <auto-generated>
//     Этот код создан по шаблону.
//
//     Изменения, вносимые в этот файл вручную, могут привести к непредвиденной работе приложения.
//     Изменения, вносимые в этот файл вручную, будут перезаписаны при повторном создании кода.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Library.Models
{
    using global::Library.Models.Custom;
    using System;
    using System.Collections.Generic;
    using System.Linq;

    public partial class Book
    {
        public int Id { get; set; }
        public string Title { get; set; }
        public string Author { get; set; }
        public string Genre { get; set; }

        public static List<BookUser> GetBooks(int id)
        {
            using (var context = new LibraryDBEntities())
            {
                var loans = context.Loan.Where(u => u.UserId == id);

                List<BookUser> books = new List<BookUser>();

                foreach (var l in loans)
                {
                    Book book = context.Book.Where(b => b.Id == l.BookId).FirstOrDefault();

                    BookUser item = new BookUser
                    {
                        Book = book,
                        EndDate = l.EndDate.ToString()
                    };

                    books.Add(item);
                }
                return books;
            }
        }

        public static void CreateBook(PostBookParams prms)
        {
            using (var context = new LibraryDBEntities())
            {
                Book newBook = new Book
                {
                    Title = prms.Title,
                    Author = prms.Author,
                    Genre = prms.Genre
                };

                var book = context.Book.Add(newBook);

                context.SaveChanges();

                int available;

                try
                {
                    int.TryParse(prms.Count, out available);

                    if (available < 0)
                    {
                        available = 0;
                    }
                }
                catch
                {
                    available = 0;
                }

                LibraryItem newItem = new LibraryItem
                {
                    BookId = book.Id,
                    LibraryId = context.Library.Where(i => i.Title == prms.LibraryTitle).FirstOrDefault().Id,
                    Count = available
                };

                context.LibraryItem.Add(newItem);

                context.SaveChanges();
            }
        }

        public static void DeleteBook(DelBookParams bookId)
        {
            using (var context = new LibraryDBEntities())
            {
                var bookToDelete = context.Book.Where(b => b.Id == bookId.bookId).FirstOrDefault();

                var itemInLibraryToDelete = context.LibraryItem.Where(i => i.BookId == bookId.bookId).FirstOrDefault();

                context.Book.Remove(bookToDelete);
                context.LibraryItem.Remove(itemInLibraryToDelete);

                var loans = context.Loan.Where(l => l.BookId == bookId.bookId);

                context.Loan.RemoveRange(loans);
                context.SaveChanges();

                context.SaveChanges();
            }
        }

        
    }

    public class DelBookParams
    {
        public int bookId { get; set; }
    }

    public class PostBookParams
    {
        public string Title { get; set; }
        public string Author { get; set; }
        public string Genre { get; set; }
        public string LibraryTitle { get; set; }
        public string Count { get; set; }
    }
}
